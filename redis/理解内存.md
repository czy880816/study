# 一、内存消耗

## 1、内存消耗的划分

Redis进程内消耗主要包括：自身内存+对象内存+缓冲内存+内存碎片,如下图所示：

![](/Users/lixiaojie/github/study/pictures/redis内存消耗划分-1.png.png)

1）对象内存是redis内存占用最大的一块，存储着用户所有的数据

redis所有的数据都是采用k-v数据类型，每次创建键值对时，至少创建两种类型的对象，键对象使用的是字符串，在使用redis时很容易忽略健对内存消耗的影响，应当避免使用过长的键。value对象复杂些，包括五种数据类型。其他数据类型都是建立在这五种数据类型之上实现的，如Bitmaps和HyperLogLog都是使用字符串实现，GEO使用有序集合实现等。

2）缓冲内存：

缓冲区内存主要包括**客户端缓冲**、**复制积压区缓冲区**、**AOF缓冲区**

**客户端缓冲**指的是所有接入redis服务器的tcp链接的输入输出缓冲。输入缓冲无法控制，最大空间1G，如果超过将断开连接，输出缓冲通过参数client-output-buffer-limit控制

**复制积压缓冲区**整个redis主节点只有一个，所有的从节点共享此缓冲区，因此可以设置较大的缓冲区空间，以防止全量复制

**AOF缓冲区**：这部分空间用于在redis重谢期间保存最近的写入命令。AOF缓冲区用户无法控制，消耗的内存取决于AOF充血时间和写入命令量，这部分空间通常占用很小

3）内存碎片：

以下操作会引起高内存碎片问题：

a、频繁做更新操作

b、大量过期键删除，键对象过期删除后，释放的空间无法得到充分利用，导致碎片率上升

高碎片率的常见解决办法：

a、数据对齐，在条件允许的情况下尽量做数据对齐，比如数据尽量采用数字类型或者固定长度字符串等

b、安全重启：重启节点可以做到内存碎片重新整理，因此可以利用高可用架构，如Sentinel或Cluster，将碎片率过高的主节点转换为从节点，进行安全重启

​                                                                               